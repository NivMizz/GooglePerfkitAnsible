---
- hosts: remoteservers
  gather_facts: true
  remote_user: root
  tasks:
    - include_role:
        name: pre_install_checks
    - name: Check if google perf kit is already installed
      stat:
        path: /opt/googleperfkit
      register: application_directory
    - name: Download master branch of GooglePerfkit and unzip
      unarchive:
        src: https://github.com/GoogleCloudPlatform/PerfKitBenchmarker/archive/master.zip
        dest: /opt/
        remote_src: yes
      when: application_directory.stat.exists == false
    - name: Rename downloaded archive
      command: mv /opt/PerfKitBenchmarker-master /opt/googleperfkit
      when: application_directory.stat.exists == false
    - copy:
        src: ../regions/digitalocean/benchmarks.yml
        dest: /root/benchmarks.yml
    - copy:
        src: ../regions/digitalocean/testpython.py
        dest: /root/testpython.py
    - name: Create result and log directories
      file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
      with_items:
        - /opt/results
        - /opt/logs
      become: yes
    - name: Upgrade pip and install pip packages
      pip:
        name: "pip"
        state: latest
      become: true
    - name: Install Azure cli
      pip:
        name: "azure-cli"
        state: latest
      become: true
    - name: Install Azure client
      shell: npm install azure-cli@0.10.4 -g
      become: yes
    - name: Install doctl for digital ocean
      unarchive:
        src: https://github.com/digitalocean/doctl/releases/download/v1.10.0/doctl-1.10.0-linux-amd64.tar.gz
        dest: /usr/local/bin
        remote_src: yes
     